<app-image-preview-modal
  [imageUrl]="previewImageUrl"
  (close)="previewImageUrl = null">
</app-image-preview-modal>

<!-- –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –ø–æ–∫–∞–∑–∞ —Ñ–æ—Ä–º—ã –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
<div class="add-comment-button-container" *ngIf="level === 0 && !parentId">
  <button class="add-comment-button" (click)="toggleAddCommentForm()">
    {{ showAddCommentForm ? '–°–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É' : '–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π' }}
  </button>
</div>

<!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
<app-add-comment
  *ngIf="showAddCommentForm"
  [postId]="postId"
  [parentId]="parentId"
  (commentAdded)="onCommentAdded()">
</app-add-comment>

<!-- –î–æ–±–∞–≤–ª—è–µ–º –±–ª–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π -->
<div class="sort-controls" *ngIf="level === 0 && comments.length > 0">
  <h4>–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</h4>
  <div class="sort-buttons">
    <button
      *ngFor="let option of sortOptions"
      class="sort-button"
      [class.active]="currentSortKey === option.key"
      (click)="onSortChange(option.key)">
      {{ option.label }}
      <span>{{ getSortIcon(option.key) }}</span>
    </button>
  </div>
</div>

<!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ -->
<div class="pagination-info" *ngIf="level === 0 && totalComments > pageSize">
  {{ paginationInfo }}
</div>

<!-- –¢–∞–±–ª–∏—Ü–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
<div class="comments-table-container" *ngIf="paginatedComments.length > 0">
  <table class="comments-table">
    <thead *ngIf="level === 0">
    <tr>
      <th>–ê–≤—Ç–æ—Ä</th>
      <th>Username</th>
      <th>–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ</th>
      <th>–î–∞—Ç–∞</th>
      <th>–û—Ç–≤–µ—Ç—ã</th>
      <th>–î–µ–π—Å—Ç–≤–∏—è</th>
    </tr>
    </thead>
    <tbody>
    <ng-container *ngFor="let comment of paginatedComments; trackBy: trackByCommentId">
      <tr class="comment-row" [class.deleted]="comment.is_deleted">
        <!-- –ê–≤—Ç–æ—Ä -->
        <td class="author-cell">
          <div class="author-info">
            <strong>{{ comment.author }}</strong>
          </div>
        </td>

        <!-- Username -->
        <td class="username-cell">
          <span class="username">{{ comment.author_username }}</span>
        </td>

        <!-- –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ -->
        <td class="content-cell">
          <div class="comment-content" [class.deleted-content]="comment.is_deleted">
            <p *ngIf="!comment.is_deleted" [innerHTML]="formatContent(comment.content)"></p>
            <p *ngIf="comment.is_deleted" class="deleted-message">
              <em>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —É–¥–∞–ª–µ–Ω</em>
            </p>

            <!-- –í–ª–æ–∂–µ–Ω–∏—è -->
            <div class="comment-attachments" *ngIf="comment.attachments?.length && !comment.is_deleted">
              <div *ngFor="let attachment of comment.attachments">
                <!-- –î–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é -->
                @if (attachment.image_url) {
                  <div class="image-preview-container">
                    <img
                      [src]="attachment.image_url"
                      [alt]="'–ü—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è'"
                      class="thumbnail-image"
                      (click)="openImagePreview(attachment.image_url)">
                  </div>
                }
              </div>
            </div>
          </div>
        </td>

        <!-- –î–∞—Ç–∞ -->
        <td class="date-cell">
          <div class="date-info">
            <span class="created-date">{{ formatDate(comment.created_at) }}</span>
            <span *ngIf="comment.updated_at !== comment.created_at" class="updated-date">
                –ò–∑–º–µ–Ω–µ–Ω–æ: {{ formatDate(comment.updated_at) }}
              </span>
          </div>
        </td>

        <!-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç–æ–≤ -->
        <td class="replies-cell">
            <span class="replies-count" *ngIf="comment.replies_count > 0">
              üí¨ {{ comment.replies_count }}
            </span>
          <span *ngIf="comment.replies_count === 0" class="no-replies">‚Äî</span>
        </td>

        <!-- –î–µ–π—Å—Ç–≤–∏—è -->
        <td class="actions-cell">
          <button
            *ngIf="comment.replies_count > 0"
            class="toggle-replies-button"
            [class.expanded]="isExpanded(comment.id)"
            (click)="toggleReplies(comment)"
            [disabled]="isLoadingReplies(comment.id)">
              <span *ngIf="!isLoadingReplies(comment.id)">
                {{ isExpanded(comment.id) ? '–°–∫—Ä—ã—Ç—å' : '–ü–æ–∫–∞–∑–∞—Ç—å' }} –æ—Ç–≤–µ—Ç—ã
              </span>
            <span *ngIf="isLoadingReplies(comment.id)">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
          </button>
          <button class="reply-button" (click)="toggleAddCommentForm(comment.id)">
            –û—Ç–≤–µ—Ç–∏—Ç—å
          </button>
        </td>
      </tr>

      <!-- –†–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–µ –æ—Ç–≤–µ—Ç—ã -->
      <tr *ngIf="isExpanded(comment.id) && comment.replies?.length">
        <td colspan="6">
          <div class="replies-section" [style.margin-left.px]="20 * (level + 1)">
            <!-- –†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–æ–≤ -->
            <app-comment-thread
              [comments]="comment.replies"
              [postId]="postId"
              [level]="level + 1"
              [parentId]="comment.id">
            </app-comment-thread>
          </div>
        </td>
      </tr>
    </ng-container>
    </tbody>
  </table>
</div>

<!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
<div class="pagination-controls" *ngIf="level === 0 && totalPages > 1">
  <button
    class="page-button"
    [disabled]="currentPage === 1"
    (click)="onPageChange(currentPage - 1)">
    ‚Äπ –ù–∞–∑–∞–¥
  </button>

  <div class="page-numbers">
    <button
      *ngFor="let page of getPaginationPages()"
      class="page-number"
      [class.current]="page === currentPage"
      (click)="onPageChange(page)">
      {{ page }}
    </button>
  </div>

  <button
    class="page-button"
    [disabled]="currentPage === totalPages"
    (click)="onPageChange(currentPage + 1)">
    –í–ø–µ—Ä–µ–¥ ‚Ä∫
  </button>
</div>

<!-- –°–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
<div class="no-comments-message" *ngIf="comments.length === 0 && level === 0">
  <p>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</p>
</div>
